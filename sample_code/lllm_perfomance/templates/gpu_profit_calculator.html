<!DOCTYPE html>
<html>
<head>
    <title>GPU Profit Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-field { @apply border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500; }
        .result-card { @apply bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 shadow-sm; }
        .profit-positive { @apply text-green-600 font-semibold; }
        .profit-negative { @apply text-red-600 font-semibold; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <h1 class="text-3xl font-bold text-gray-800">GPU Profit Calculator</h1>
                <button onclick="window.location.href='/settings'" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    ⚙️ Settings
                </button>
            </div>
            <p class="text-gray-600">Calculate profitability for GPU-based LLM inference</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Input Form -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Configuration</h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Model Selection -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Model (Optional)</label>
                        <select id="modelSelect" class="input-field w-full" onchange="onModelSelect()">
                            <option value="">-- Select a model to auto-fill parameters --</option>
                            <optgroup label="Free Models">
                                {% for model in free_models %}
                                <option value="{{ model.name }}" data-input-tps="{{ model.tokens_per_gpu_tps * 0.3 }}" data-output-tps="{{ model.tokens_per_gpu_tps * 0.7 }}" data-input-price="{{ "%.3f"|format(model.input_price_per_m) }}" data-output-price="{{ "%.3f"|format(model.output_price_per_m) }}" data-gpu="{{ model.typical_gpu }}" data-parameters="{{ model.parameters_b }}" data-precision="{{ model.precision }}" data-openrouter-link="{{ model.openrouter_link }}">{{ model.name }} ({{ model.typical_gpu }}, {{ model.parameters_b }}B)</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Paid Models">
                                {% for model in paid_models %}
                                <option value="{{ model.name }}" data-input-tps="{{ model.tokens_per_gpu_tps * 0.3 }}" data-output-tps="{{ model.tokens_per_gpu_tps * 0.7 }}" data-input-price="{{ "%.3f"|format(model.input_price_per_m) }}" data-output-price="{{ "%.3f"|format(model.output_price_per_m) }}" data-gpu="{{ model.typical_gpu }}" data-parameters="{{ model.parameters_b }}" data-precision="{{ model.precision }}" data-openrouter-link="{{ model.openrouter_link }}">{{ model.name }} ({{ model.typical_gpu }}, {{ model.parameters_b }}B)</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select a model to automatically populate TPS and pricing</p>
                    </div>
                    
                    <!-- GPU Selection -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select GPU Configuration</label>
                        <select id="gpuSelect" class="input-field w-full" onchange="onGPUSelect()">
                            <option value="">-- Select GPU configuration --</option>
                            {% for gpu in gpu_configs %}
                            <option value="{{ gpu.name }}" 
                                    data-cost="{{ gpu.cost_per_hour }}" 
                                    data-vram="{{ gpu.vram_gb }}" 
                                    data-type="{{ gpu.gpu_type }}">
                                {{ gpu.name }} - ${{ "%.2f"|format(gpu.cost_per_hour) }}/hour ({{ gpu.vram_gb }}GB)
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select GPU or let model auto-select the best option</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU Cost per Hour ($)</label>
                        <input type="number" id="gpuCost" value="2.0" step="0.1" min="0" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU Count</label>
                        <input type="number" id="gpuCount" value="8" min="1" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Input Tokens/sec</label>
                        <input type="number" id="inputTPS" value="1000" min="0" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Output Tokens/sec</label>
                        <input type="number" id="outputTPS" value="2000" min="0" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    
                                           <div>
                           <label class="block text-sm font-medium text-gray-700 mb-1">Real Input Tokens/sec</label>
                           <input type="number" id="realInputTPS" value="1000" min="0" 
                                  class="input-field w-full" onchange="calculateProfit()">
                           <p class="text-xs text-gray-500 mt-1">Actual tested input TPS (defaults to theoretical value)</p>
                       </div>
                       
                       <div>
                           <label class="block text-sm font-medium text-gray-700 mb-1">Real Output Tokens/sec</label>
                           <input type="number" id="realOutputTPS" value="2000" min="0" 
                                  class="input-field w-full" onchange="calculateProfit()">
                           <p class="text-xs text-gray-500 mt-1">Actual tested output TPS (defaults to theoretical value)</p>
                       </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Input Price ($/M tokens)</label>
                        <input type="number" id="inputPrice" value="0.100" step="0.001" min="0" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Output Price ($/M tokens)</label>
                        <input type="number" id="outputPrice" value="0.200" step="0.001" min="0" 
                               class="input-field w-full" onchange="calculateProfit()">
                    </div>
                </div>
                
                <!-- Model Information (Compact) -->
                <div id="compactModelInfo" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                    <div class="grid md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Model:</span>
                            <span class="font-mono ml-2" id="selectedModelName">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">GPU Type:</span>
                            <span class="font-mono ml-2" id="selectedGPUType">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">VRAM Required:</span>
                            <span class="font-mono ml-2" id="requiredVRAM">-</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">OpenRouter:</span>
                            <span class="font-mono ml-2" id="openRouterLink">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Profitability Analysis</h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Theoretical Total TPS:</span>
                        <span class="font-mono font-semibold" id="theoreticalTotalTPS">3,000</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Real Total TPS:</span>
                        <span class="font-mono font-semibold text-blue-600" id="realTotalTPS">2,500</span>
                    </div>
                    
                                    <div class="flex justify-between">
                    <span class="text-gray-600">Real Tokens/hour:</span>
                    <span class="font-mono font-semibold" id="realTokensPerHour">9,000,000</span>
                </div>
                
                <div class="flex justify-between">
                    <span class="text-gray-600">Daily Generated Tokens:</span>
                    <span class="font-mono font-semibold text-green-600" id="dailyGeneratedTokens">216,000,000</span>
                </div>
                
                <div class="flex justify-between">
                    <span class="text-gray-600">Revenue per Day:</span>
                    <span class="font-mono font-semibold text-blue-600" id="revenuePerDay">$38.88</span>
                </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cost/hour:</span>
                        <span class="font-mono font-semibold text-red-600" id="costPerHour">$16.00</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Revenue/M tokens:</span>
                        <span class="font-mono font-semibold" id="revenuePerMTokens">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cost/M tokens:</span>
                        <span class="font-mono font-semibold text-red-600" id="costPerMTokens">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Profit/M tokens:</span>
                        <span class="font-mono font-semibold" id="profitPerMTokens">$0.00</span>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="flex justify-between text-lg">
                        <span class="text-gray-700 font-medium">Profit/hour:</span>
                        <span class="font-mono font-bold" id="profitPerHour">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-xl">
                        <span class="text-gray-800 font-semibold">Profit/day:</span>
                        <span class="font-mono font-bold" id="profitPerDay">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-xl">
                        <span class="text-gray-800 font-semibold">Profit/month:</span>
                        <span class="font-mono font-bold" id="profitPerMonth">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-lg">
                        <span class="text-gray-700 font-medium">Cost/month:</span>
                        <span class="font-mono font-bold text-red-600" id="costPerMonth">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-lg">
                        <span class="text-gray-700 font-medium">ROI (30 days):</span>
                        <span class="font-mono font-bold" id="roi30Days">0%</span>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        function onModelSelect() {
            const select = document.getElementById('modelSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const inputTPS = parseFloat(selectedOption.dataset.inputTps) || 0;
                const outputTPS = parseFloat(selectedOption.dataset.outputTps) || 0;
                            const inputPrice = Math.round(parseFloat(selectedOption.dataset.inputPrice?.replace('$', '')) * 1000) / 1000 || 0;
            const outputPrice = Math.round(parseFloat(selectedOption.dataset.outputPrice?.replace('$', '')) * 1000) / 1000 || 0;
                const gpu = selectedOption.dataset.gpu || '';
                const parameters = selectedOption.dataset.parameters || '';
                const precision = selectedOption.dataset.precision || '';
                const openRouterLink = selectedOption.dataset.openrouterLink || '';
                
                                    document.getElementById('inputTPS').value = Math.round(inputTPS);
                    document.getElementById('outputTPS').value = Math.round(outputTPS);
                    // Set real input/output TPS to same as theoretical values
                    document.getElementById('realInputTPS').value = Math.round(inputTPS);
                    document.getElementById('realOutputTPS').value = Math.round(outputTPS);
                document.getElementById('inputPrice').value = inputPrice;
                document.getElementById('outputPrice').value = outputPrice;
                
                // Show compact model information
                showCompactModelInfo(selectedOption.value, gpu, parameters, precision, openRouterLink);
                
                // Auto-select the best GPU for this model
                autoSelectBestGPU(gpu, parameters, precision);
                
                calculateProfit();
            }
        }
        
        function onGPUSelect() {
            const gpuSelect = document.getElementById('gpuSelect');
            const selectedOption = gpuSelect.options[gpuSelect.selectedIndex];
            
            if (selectedOption.value) {
                const gpuCost = parseFloat(selectedOption.dataset.cost);
                document.getElementById('gpuCost').value = gpuCost.toFixed(2);
                calculateProfit();
            }
        }
        
        function showCompactModelInfo(modelName, recommendedGPU, parameters, precision, openRouterLink) {
            const compactModelInfo = document.getElementById('compactModelInfo');
            const params = parseFloat(parameters);
            
            // Update compact model info display
            document.getElementById('selectedModelName').textContent = modelName;
            document.getElementById('selectedGPUType').textContent = getGPUType(recommendedGPU);
            document.getElementById('requiredVRAM').textContent = getVRAMRequirement(params, precision);
            
            // Handle OpenRouter link
            const openRouterElement = document.getElementById('openRouterLink');
            if (openRouterLink && openRouterLink.trim() !== '') {
                openRouterElement.innerHTML = `<a href="${openRouterLink}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">View Model</a>`;
            } else {
                openRouterElement.textContent = 'Not available';
            }
            
            // Show the compact info section
            compactModelInfo.classList.remove('hidden');
        }
        
        function getGPUType(gpu) {
            if (gpu.includes('H100')) return 'Data Center GPU';
            if (gpu.includes('A100')) return 'Data Center GPU';
            if (gpu.includes('RTX 3090')) return 'Consumer GPU';
            if (gpu.includes('RTX 3080')) return 'Consumer GPU';
            return 'GPU';
        }
        
        function getVRAMRequirement(parameters, precision) {
            if (precision === 'MoE') {
                return '~80GB+ (MoE models)';
            } else if (parameters >= 100) {
                return '~80GB+ (Large models)';
            } else if (parameters >= 30) {
                return '~40-80GB';
            } else if (parameters >= 10) {
                return '~20-40GB';
            } else {
                return '~8-20GB';
            }
        }
        
        function autoSelectBestGPU(recommendedGPU, parameters, precision) {
            const gpuSelect = document.getElementById('gpuSelect');
            const params = parseFloat(parameters);
            
            let bestGPU = null;
            let bestScore = -1;
            
            for (let i = 0; i < gpuSelect.options.length; i++) {
                const option = gpuSelect.options[i];
                if (!option.value) continue;
                
                const gpuName = option.value;
                const gpuCost = parseFloat(option.dataset.cost);
                const gpuVRAM = parseInt(option.dataset.vram);
                const gpuType = option.dataset.type;
                
                let score = 0;
                
                // Score based on recommended GPU match (highest priority)
                if (gpuName.includes(recommendedGPU) || recommendedGPU.includes(gpuName.split(' ')[0])) {
                    score += 200;
                }
                
                // Score based on VRAM requirements and model size
                const requiredVRAM = getRequiredVRAM(params, precision);
                if (gpuVRAM >= requiredVRAM) {
                    score += 100;
                    // Bonus for optimal VRAM (not too much excess)
                    if (gpuVRAM <= requiredVRAM * 1.5) {
                        score += 50;
                    }
                    // Penalty for excessive VRAM (waste of resources)
                    if (gpuVRAM > requiredVRAM * 3) {
                        score -= 30;
                    }
                } else {
                    // Heavy penalty for insufficient VRAM
                    score -= 200;
                }
                
                // Score based on GPU type and model characteristics
                if (params >= 70 || precision === 'MoE') {
                    // Large models (70B+) and MoE models prefer Data Center GPUs
                    if (gpuType === 'Data Center') {
                        score += 80;
                        // Prefer H100 for very large models
                        if (params >= 100 && gpuName.includes('H100')) {
                            score += 40;
                        }
                        // Prefer A100 for large but not massive models
                        if (params >= 70 && params < 100 && gpuName.includes('A100')) {
                            score += 30;
                        }
                    } else {
                        score -= 50; // Penalty for consumer GPUs on large models
                    }
                } else if (params >= 30) {
                    // Medium models (30-70B) can use either type
                    if (gpuType === 'Data Center') {
                        score += 40;
                    } else if (gpuType === 'Consumer') {
                        score += 20;
                    }
                } else {
                    // Small models (<30B) prefer Consumer GPUs for cost efficiency
                    if (gpuType === 'Consumer') {
                        score += 60;
                        // Prefer RTX 3090 for small models
                        if (gpuName.includes('RTX 3090')) {
                            score += 20;
                        }
                    } else {
                        score -= 30; // Penalty for expensive Data Center GPUs on small models
                    }
                }
                
                // Score based on cost efficiency
                const costEfficiency = 100 - (gpuCost * 20); // Adjusted multiplier
                score += Math.max(0, costEfficiency);
                
                // Special considerations for specific model types
                if (precision === 'MoE') {
                    // MoE models need high VRAM and prefer Data Center GPUs
                    if (gpuVRAM >= 80 && gpuType === 'Data Center') {
                        score += 60;
                    }
                } else if (precision === 'AWQ') {
                    // AWQ models are more efficient, can use consumer GPUs
                    if (gpuType === 'Consumer' && gpuVRAM >= 24) {
                        score += 30;
                    }
                }
                
                // Prefer newer GPU generations
                if (gpuName.includes('H100')) {
                    score += 20; // Latest generation
                } else if (gpuName.includes('A100')) {
                    score += 15; // Previous generation
                } else if (gpuName.includes('RTX 4090')) {
                    score += 10; // Latest consumer
                } else if (gpuName.includes('RTX 3090')) {
                    score += 5; // Previous consumer
                }
                
                if (score > bestScore) {
                    bestScore = score;
                    bestGPU = option;
                }
            }
            
            if (bestGPU) {
                gpuSelect.value = bestGPU.value;
                const selectedCost = parseFloat(bestGPU.dataset.cost);
                document.getElementById('gpuCost').value = selectedCost.toFixed(2);
                
                // Log selection for debugging
                console.log(`Auto-selected ${bestGPU.value} for ${params}B model (${precision}) with score ${bestScore}`);
            }
        }
        
        function getRequiredVRAM(parameters, precision) {
            if (precision === 'MoE') {
                return 80; // MoE models need high VRAM
            } else if (precision === 'AWQ') {
                // AWQ models are more memory efficient
                if (parameters >= 100) return 80;
                if (parameters >= 70) return 60;
                if (parameters >= 30) return 40;
                if (parameters >= 10) return 20;
                return 8;
            } else {
                // Standard models
                if (parameters >= 100) return 80;
                if (parameters >= 70) return 60;
                if (parameters >= 30) return 40;
                if (parameters >= 10) return 20;
                return 8;
            }
        }

        function calculateProfit() {
            const gpuCost = parseFloat(document.getElementById('gpuCost').value) || 0;
            const gpuCount = parseInt(document.getElementById('gpuCount').value) || 0;
            const inputTPS = parseFloat(document.getElementById('inputTPS').value) || 0;
            const outputTPS = parseFloat(document.getElementById('outputTPS').value) || 0;
            const realInputTPS = parseFloat(document.getElementById('realInputTPS').value) || 0;
            const realOutputTPS = parseFloat(document.getElementById('realOutputTPS').value) || 0;
                    const inputPrice = Math.round(parseFloat(document.getElementById('inputPrice').value) * 1000) / 1000 || 0;
        const outputPrice = Math.round(parseFloat(document.getElementById('outputPrice').value) * 1000) / 1000 || 0;

            // Theoretical calculations (using input + output TPS)
            const theoreticalTotalTPS = inputTPS + outputTPS;
            const theoreticalTokensPerHour = theoreticalTotalTPS * 3600;
            
            // Real calculations (using real input + real output TPS)
            const realTotalTPS = realInputTPS + realOutputTPS;
            const realTokensPerHour = realTotalTPS * 3600;
            const dailyGeneratedTokens = realTokensPerHour * 24;
            
            const costPerHour = gpuCost * gpuCount;
            const costPerMTokens = (costPerHour / realTokensPerHour) * 1_000_000;
            
            const revenuePerMTokens = Math.round(((realInputTPS * inputPrice) + (realOutputTPS * outputPrice)) / realTotalTPS * 1000) / 1000;
            const profitPerMTokens = Math.round((revenuePerMTokens - costPerMTokens) * 1000) / 1000;
            const profitPerHour = profitPerMTokens * realTokensPerHour / 1_000_000;
            const profitPerDay = profitPerHour * 24;
            const profitPerMonth = profitPerDay * 30;
            const costPerMonth = costPerHour * 24 * 30;
            
            // Calculate daily revenue
            const revenuePerDay = revenuePerMTokens * dailyGeneratedTokens / 1_000_000;

            // Update display
            document.getElementById('theoreticalTotalTPS').textContent = theoreticalTotalTPS.toLocaleString();
            document.getElementById('realTotalTPS').textContent = realTotalTPS.toLocaleString();
            document.getElementById('realTokensPerHour').textContent = realTokensPerHour.toLocaleString();
            document.getElementById('dailyGeneratedTokens').textContent = dailyGeneratedTokens.toLocaleString();
            document.getElementById('revenuePerDay').textContent = '$' + revenuePerDay.toFixed(2);
            document.getElementById('costPerHour').textContent = '$' + costPerHour.toFixed(2);
            document.getElementById('revenuePerMTokens').textContent = '$' + revenuePerMTokens.toFixed(3);
            document.getElementById('costPerMTokens').textContent = '$' + costPerMTokens.toFixed(3);
            document.getElementById('profitPerMTokens').textContent = '$' + profitPerMTokens.toFixed(3);
            
            const profitPerHourElement = document.getElementById('profitPerHour');
            profitPerHourElement.textContent = '$' + profitPerHour.toFixed(2);
            profitPerHourElement.className = profitPerHour >= 0 ? 'font-mono font-bold profit-positive' : 'font-mono font-bold profit-negative';
            
            const profitPerDayElement = document.getElementById('profitPerDay');
            profitPerDayElement.textContent = '$' + profitPerDay.toFixed(2);
            profitPerDayElement.className = profitPerDay >= 0 ? 'font-mono font-bold profit-positive' : 'font-mono font-bold profit-negative';
            
            const profitPerMonthElement = document.getElementById('profitPerMonth');
            profitPerMonthElement.textContent = '$' + profitPerMonth.toFixed(2);
            profitPerMonthElement.className = profitPerMonth >= 0 ? 'font-mono font-bold profit-positive' : 'font-mono font-bold profit-negative';
            
            document.getElementById('costPerMonth').textContent = '$' + costPerMonth.toFixed(2);

            // Calculate ROI (assuming $20k per H100)
            const totalGPUInvestment = gpuCount * 20000;
            const roi30Days = totalGPUInvestment > 0 ? (profitPerMonth / totalGPUInvestment * 100) : 0;
            document.getElementById('roi30Days').textContent = roi30Days.toFixed(1) + '%';
        }

        // Initialize calculation on page load
        document.addEventListener('DOMContentLoaded', calculateProfit);
    </script>
</body>
</html>